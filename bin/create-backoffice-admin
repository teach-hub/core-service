#!/bin/bash

echo 'Creating backoffice admin...'

if [[ -z "${PASSWORD_HASH_SECRET}" ]]; then
  echo 'Missing PASSWORD_HASH_SECRET env var.'
  exit 1
fi

if [[ -z "${DB_URI}" ]]; then
  echo 'Missing DB_URI env var.'
  exit 1
fi

ADMIN_EMAIL="admin@teachhub.com"
NAME="TeachHub Admin"
PASSWORD=$(cat /dev/urandom | tr -dc '[:alpha:]' | fold -w ${1:-20} | head -n 1)

echo "Creating admin user with email: $ADMIN_EMAIL"

HASHED_PASSWORD=$(echo -n $PASSWORD | openssl dgst -sha256 -hmac $PASSWORD_HASH_SECRET | sed 's/^.* //')

echo "Password: $PASSWORD"

psql -v ON_ERROR_STOP=1 "$DB_URI" << EOSQL
  INSERT INTO teachhub.admin_users (email, name, password)
  VALUES ('$ADMIN_EMAIL', '$NAME', '$HASHED_PASSWORD');
EOSQL
